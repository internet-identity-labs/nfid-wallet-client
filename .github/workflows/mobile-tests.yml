name: Mobile Tests CI

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to run against"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - production
      device:
        description: "Device to run tests with"
        required: true
        default: "Pixel 5"
        type: choice
        options:
          - Pixel 5
          - iPhone X
          - Galaxy S8
      logLevel:
        description: "Log level"
        required: true
        default: "warning"
        type: choice
        options:
          - info
          - warning
          - debug

env:
  CI_DEBUG: "true"

jobs:
  check-secrets:
    name: Check Secrets
    defaults:
      run:
        shell: bash

    runs-on: ubuntu-latest

    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
          repository: internet-identity-labs/ci_libs
          ref: main
          path: ci_libs

      - name: Check secrets
        run: |
          source ${{ github.workspace }}/ci_libs/CI_LIBS.sh
          JSON='${{ toJSON(env) }}'
          ci_check_secrets "${JSON}"
        env:
          URL_AWS_USER_E2E_GOOGLE: ${{secrets.URL_AWS_USER_E2E_GOOGLE}}
          LAMBDA_IDENTITY: ${{secrets.LAMBDA_IDENTITY}}
          USERGEEK_API_KEY: ${{secrets.PROD_USERGEEK_API_KEY}}
          USER_DATA_DIR: ${{secrets.USER_DATA_DIR}}
          PSYCHEDELIC_GH_NPM_REGISTRY: ${{secrets.PSYCHEDELIC_GH_NPM_REGISTRY}}
          BLOCK_CYPHER_TOKEN: ${{secrets.BLOCK_CYPHER_TOKEN_DEV}}

  e2e-tests:
    name: E2E Tests
    needs: check-secrets
    runs-on: ubuntu-latest
    concurrency:
      group: ci-frontend-test
      cancel-in-progress: false

    steps:
      - run: pwd

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Checkout CI repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
          repository: internet-identity-labs/ci_libs
          ref: main
          path: ci_libs

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "yarn"

      - name: Versions
        run: |
          source ${{ github.workspace }}/ci_libs/CI_LIBS.sh

          ci_versions

      - name: Build project
        run: |
          source ${{ github.workspace }}/ci_libs/CI_LIBS.sh

          cat > ~/.npmrc << EOF
          @psychedelic:registry=https://npm.pkg.github.com
          //npm.pkg.github.com/:_authToken=${PSYCHEDELIC_GH_NPM_REGISTRY}
          EOF

          ci_echo_debug "yarn --prefer-offline" >&2
          yarn --prefer-offline --frozen-lockfile

          ci_echo_debug "npx env-cmd -f .env.staging nx build nfid-frontend" >&2
          npx env-cmd -f .env.staging nx build nfid-frontend

          ci_echo_debug "yarn serve -l 9090 -s dist/apps/nfid-frontend &" >&2
          yarn serve -l 9090 -s dist/apps/nfid-frontend &
        env:
          IS_DEV: true
          IS_E2E_TEST: true
          RAMP_WALLET_API_KEY: ${{secrets.RAMP_WALLET_API_KEY}}

          USERGEEK_API_KEY: ${{secrets.PROD_USERGEEK_API_KEY}}
          PSYCHEDELIC_GH_NPM_REGISTRY: ${{secrets.PSYCHEDELIC_GH_NPM_REGISTRY}}
          BLOCK_CYPHER_TOKEN: ${{secrets.BLOCK_CYPHER_TOKEN_DEV}}

      - name: Setup chrome browser
        uses: browser-actions/setup-chrome@latest

      - name: Chrome version
        run: chrome --version

      - name: Checkout Google user E2E
        uses: actions/checkout@v4
        with:
          repository: internet-identity-labs/user-google-e2e
          path: apps/nfid-frontend-e2e/user-google-e2e
          ref: main
          token: ${{ secrets.PAT }}

      - run: ls -la apps/nfid-frontend-e2e/user-google-e2e

      - name: Running E2E test
        run: |
          source ${{ github.workspace }}/ci_libs/CI_LIBS.sh

          ci_echo_debug "npx nx clean nfid-frontend-e2e" >&2
          npx nx clean nfid-frontend-e2e

          ci_echo_debug "DEVICE_NAME=${{ github.event.inputs.device }} IS_HEADLESS='true' npx env-cmd -f .env.${{ github.event.inputs.env || 'dev' }} nx test:e2e:mobile nfid-frontend-e2e" >&2
          DEVICE_NAME=${{ github.event.inputs.device }} IS_HEADLESS='true' npx env-cmd -f .env.${{ github.event.inputs.env || 'dev' }} nx test:e2e:mobile nfid-frontend-e2e
        env:
          URL_AWS_USER_E2E_GOOGLE: ${{secrets.URL_AWS_USER_E2E_GOOGLE}}
          LAMBDA_IDENTITY: ${{secrets.LAMBDA_IDENTITY}}
          USER_DATA_DIR: ${{secrets.USER_DATA_DIR}}

      - name: Save test results
        if: ${{ ! cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          path: apps/nfid-frontend-e2e/allure-results
          name: allure-results-${{github.RUN_ID}}${{github.RUN_ATTEMPT}}

      - name: Upload Chrome logs
        uses: actions/upload-artifact@v4
        if: ${{ ! cancelled() }}
        with:
          retention-days: 1
          name: chrome_debug.log
          path: apps/nfid-frontend-e2e/user-google-e2e/chrome_debug.log

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: ${{ ! cancelled() }}
        with:
          retention-days: 1
          name: dist
          path: dist

  allure-report:
    name: Allure Reports
    needs: e2e-tests
    if: ${{ ! cancelled() }}
    runs-on: ubuntu-latest
    env:
      URL: ${{ github.event.pull_request.comments_url }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TARGET_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{github.RUN_ID}}${{github.RUN_ATTEMPT}}
    steps:
      - name: Get history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Load test results
        uses: actions/download-artifact@v4
        with:
          name: allure-results-${{github.RUN_ID}}${{github.RUN_ATTEMPT}}
          path: apps/nfid-frontend-e2e/allure-results

      - name: Preparing the report
        uses: simple-elf/allure-report-action@master
        id: allure-report
        with:
          allure_results: apps/nfid-frontend-e2e/allure-results
          gh_pages: gh-pages
          allure_report: apps/nfid-frontend-e2e/allure-report
          allure_history: apps/nfid-frontend-e2e/allure-history
          keep_reports: 20
          github_run_num: ${{github.RUN_ID}}${{github.RUN_ATTEMPT}}

      - name: Deploy report to Github Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          PERSONAL_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_BRANCH: gh-pages
          PUBLISH_DIR: apps/nfid-frontend-e2e/allure-history

      - name: Upload url to file
        env:
          target_url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{github.RUN_ID}}${{github.RUN_ATTEMPT}}
        run: echo "$target_url" > "report_url.txt"

      - name: Upload url to PR comments
        run: |
          if [ -n "${URL}" ]; then
            printf -v data '{ "body": "%s" }' "$TARGET_URL" &&
            curl \
              -X POST \
              $URL \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -d "$data"
          fi

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: ReportUrl
          path: "report_url.txt"
